# Open-RMF Docker Image
# Build on top of the base ROS Gazebo image
FROM ros-gazebo-base:latest

# Switch back to root for installations
USER root

# Install Open-RMF core binaries first to get dependencies right
RUN apt-get update && apt-get install -y \
    ros-dev-tools \
    python3-shapely \
    python3-yaml \
    python3-requests \
    ros-jazzy-rmf-dev \
    ros-jazzy-rmf-fleet-msgs \
    ros-jazzy-rmf-building-map-msgs \
    ros-jazzy-rmf-door-msgs \
    ros-jazzy-rmf-lift-msgs \
    ros-jazzy-rmf-traffic-msgs \
    ros-jazzy-rmf-building-sim-gz-plugins \
    && rm -rf /var/lib/apt/lists/*

# Switch to user for workspace setup
USER ros

# Update rosdep (as mentioned in README)
RUN rosdep update

# Update colcon mixin (following README instructions)
RUN colcon mixin add default https://raw.githubusercontent.com/colcon/colcon-mixin-repository/master/index.yaml && \
    colcon mixin update default

# Create rmf workspace for demos only (hybrid approach)
RUN mkdir -p /home/ros/rmf_ws/src
WORKDIR /home/ros/rmf_ws

# Switch back to root for dependency installation (rosdep needs sudo)
USER root

# Install dependencies using rosdep (let it handle what it can)
RUN /bin/bash -c "source /opt/ros/jazzy/setup.bash && \
    rosdep install --from-paths /home/ros/rmf_ws/src --ignore-src --rosdistro jazzy -y --skip-keys='ros-jazzy-backward-ros backward-ros' || true"

# Switch back to root to install Python packages system-wide for ROS runtime
USER root

# Install Python packages system-wide since ROS nodes need them at runtime
# Use --no-deps to avoid conflicts with system packages
RUN pip3 install --break-system-packages --no-deps "pydantic==2.10.3" "pydantic-core==2.27.1" "annotated-types==0.7.0" "typing-inspection==0.4.1" && \
    pip3 install --break-system-packages --no-deps fastapi uvicorn websockets paho-mqtt flask-socketio flask-cors starlette anyio click h11 sniffio bidict python-engineio python-socketio simple-websocket wsproto blinker itsdangerous jinja2 markupsafe werkzeug flask

# Switch back to ros user for building
USER ros

# Create virtual environment for build process (Ubuntu 24.04 requirement)
RUN python3 -m venv --system-site-packages venv_rmf_ros2

# Install cmake in virtual environment for building
RUN /bin/bash -c ". venv_rmf_ros2/bin/activate && \
    pip install cmake"

# Build just the demos (much lighter and more practical for learning)
RUN /bin/bash -c ". venv_rmf_ros2/bin/activate && \
    source /opt/ros/jazzy/setup.bash && \
    colcon build --mixin release --cmake-args -DCMAKE_BUILD_TYPE=Release"

# Update bashrc to source Open-RMF workspace and set environment (hybrid approach)
RUN echo "source /home/ros/rmf_ws/install/setup.bash" >> /home/ros/.bashrc && \
    echo "export GAZEBO_MODEL_PATH=\$GAZEBO_MODEL_PATH:/home/ros/rmf_ws/install/rmf_demos_assets/share/rmf_demos_assets/models:/home/ros/.gazebo/models" >> /home/ros/.bashrc && \
    echo "export GZ_SIM_SYSTEM_PLUGIN_PATH=\$GZ_SIM_SYSTEM_PLUGIN_PATH:/opt/ros/jazzy/lib/rmf_robot_sim_gz_plugins:/home/ros/rmf_ws/install/rmf_robot_sim_gz_plugins/lib:/opt/ros/jazzy/lib/rmf_building_sim_gz_plugins:/home/ros/rmf_ws/install/rmf_building_sim_gz_plugins/lib" >> /home/ros/.bashrc && \
    echo "export GZ_GUI_PLUGIN_PATH=\$GZ_GUI_PLUGIN_PATH:/opt/ros/jazzy/lib/rmf_building_sim_gz_plugins:/home/ros/rmf_ws/install/rmf_building_sim_gz_plugins/lib" >> /home/ros/.bashrc && \
    echo "export GZ_SIM_RESOURCE_PATH=\$GZ_SIM_RESOURCE_PATH:/home/ros/rmf_ws/install/rmf_demos_assets/share/rmf_demos_assets:/home/ros/.gazebo" >> /home/ros/.bashrc

# Ensure .ros and .gazebo directories have correct permissions and set up model links
RUN mkdir -p /home/ros/.ros /home/ros/.gazebo/models/Open-RMF && \
    chown -R ros:ros /home/ros/.ros /home/ros/.gazebo && \
    ln -sf /home/ros/rmf_ws/install/rmf_demos_assets/share/rmf_demos_assets/models/* /home/ros/.gazebo/models/Open-RMF/ || true

# Set working directory
WORKDIR /home/ros/rmf_ws

# Default command
CMD ["/bin/bash"] 